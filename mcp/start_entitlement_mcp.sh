#!/bin/bash

# Start Entitlement MCP Server
# This script starts the MCP server for entitlement checking

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  ğŸš€ Starting Entitlement MCP Server"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

cd "$(dirname "$0")"

# Check if Python is available
if ! command -v python3 &> /dev/null; then
    echo "âŒ ERROR: Python 3 is not installed"
    echo "Please install Python 3.8 or higher"
    exit 1
fi

echo "âœ… Python version: $(python3 --version)"
echo ""

# Virtual environment setup
VENV_DIR="venv"

if [ ! -d "$VENV_DIR" ]; then
    echo "ğŸ“¦ Creating virtual environment..."
    python3 -m venv "$VENV_DIR"
    echo "âœ… Virtual environment created"
else
    echo "âœ… Virtual environment found"
fi

echo ""
echo "ğŸ”„ Activating virtual environment..."

# Activate virtual environment
source "$VENV_DIR/bin/activate"

echo "âœ… Virtual environment activated"
echo ""

# Check and install dependencies
echo "ğŸ“¦ Checking dependencies..."

python -c "import httpx" 2>/dev/null
HTTPX_INSTALLED=$?

python -c "import mcp" 2>/dev/null
MCP_INSTALLED=$?

if [ $HTTPX_INSTALLED -ne 0 ] || [ $MCP_INSTALLED -ne 0 ]; then
    echo "ğŸ“¥ Installing dependencies..."
    pip install httpx>=0.27.0 mcp>=1.0.0
    
    if [ $? -eq 0 ]; then
        echo "âœ… Dependencies installed successfully"
    else
        echo "âŒ Failed to install dependencies"
        exit 1
    fi
else
    echo "âœ… All dependencies already installed"
fi

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  ğŸ“‹ Configuration"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "  Profile API: https://localhost:8080/services/security/profile"
echo "  SSL Verification: Disabled (Development Mode)"
echo "  Virtual Environment: $(pwd)/$VENV_DIR"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  ğŸ¯ MCP Server Ready"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "Starting entitlement MCP server..."
echo "Press Ctrl+C to stop"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Run the MCP server
python entitlement_mcp.py

